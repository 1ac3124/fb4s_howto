# Стандартная прошивка FB5/4S

В принтеры FB5 и FB4S используется одинаковая плата - Robin Nano 1.*, поэтому прошивка, настройки и управление не отличается.

На данный момент последней прошивкой для FB5 считается 5.8 Какого-то официального сайта с прошивкой нет. Наиболее официальный источник прошивки - ссылка под видео в youtube на папку в google drive.

Архив с прошивкой состоит из нескольких папок и файлов:

```
mks_font  - папка с шрифтами
mks_pic - папка с картинками
MksWifi.bin - прошивка WIFI модуля
Robin_nano35.bin - прошивка платы управления принтером
robin_nano35_cfg.txt - файл настроек
╨▐╕──┌╚▌.txt - changelog на китайском
```

На плате установлен МК STM32F103, у него всего 512Кб flash памяти. Картинки туда не влезут. Поэтому для картинок на плате установлена дополнительная flash-память W25Q, картинки хранятся в ней. Загружает туда картинки сама прошивка. Если при запуске на SD карте есть папка mks_pic, то из нее будут загружены картинки, а папка будет переименована в bak_pic. Аналогично с папкой mks_font.

**MksWifi.bin** - это прошивка для модуля ESP8266, который установлен на плате.

**Robin_nano35.bin** - это прошивка для платы управления. Это программа, которая будет работать внутри МК и управлять печатью. Если при включении принтера на SD карте есть файл Robin_nano35.bin, он будет прошит в микроконтроллер, а сам файл будет переименован в Robin_nano35.cur. Загружает прошивку бутлоадер, который так же находится внутри МК. Прошивка с SD карты абсолютно безопасный процесс. Если прервать процесс или загрузить какой-то мусор вместо прошивки, то плата просто не запустится. В таком случае достаточно снова скопировать на карту памяти файл Robin_nano35.bin и включить принтер. Бутлоадер загрузит прошивку и все исправит.

**robin_nano35_cfg.txt** - файл настроек прошивки. Не все настройки дотупны из меню принтера, некоторые можно изменить в этом файле. Это не прошивка, а только настройки. Для применения настроек нужно положить на карту памяти файл robin_nano35_cfg.txt и прошивка при запуске считает оттуда настройки. Если настройки были считаны, файл будет переименован в robin_nano35_cfg.cur. Если понадобится опять что-то изменить, файл снова нужно переименовать в robin_nano35_cfg.txt

## Основные настройки

### Шаговые двигатели

Для движения осей используеются шаговые двигатели. Общий принцип работы можно посмотреть в [видео](https://www.youtube.com/watch?v=r_V8vIuEPws). Для управления двигателем используется специальная микросхема - драйвер. С точки зрения прошивки, двигатель управляется 2-мя сигналами - направление и шаги. Сигнал "направление" может быть или 0 или 1, и в зависимости от этого двигатель будет вращаться в одну или в другую сторону. У разных драйверов направление вращения может отличаться. Кроме того, оно зависит от того, как подключены обмотки двигателя. Настройка этого параметра называется "инвертирование осей". Если после замены драйверов у вас происходит движение не в ту сторону (проверить можно из меню движения принтера), нужно просто инвертировать этот параметр. Если был 1 поставить 0, если был 0, постаивть 1.

В файле robin_nano35_cfg.txt это параметры:

```
>INVERT_X_DIR 	        0	
>INVERT_Y_DIR 	        0
>INVERT_Z_DIR          	0
>INVERT_E0_DIR        	0
>INVERT_E1_DIR         	0 - E1 это для второго экструдера, он не используется.
```

Второй параметр упраления шаговым двигателем - шаги. Плата управления выдает на драйвер импульсы, которые драйвер преобразует в ток на обмотках двигателя. С точки зрения двигателя, есть понятие полного шага и микрошага (подробнее про это в видео). С точки зрения программы управления, шаги это микрошаги. Т.е. сколько сделать импульсов, чтобы двигатель повернулся на нужный угол. На какой конкретно угол драйвер повернет двигатель зависит от настроек деления шагов.
Например возьмем двигатель с шагом 1.8 градуса (полный оборот 200 полных шагов). Если деление шагов стоит 1/1, то на каждый импульс от платы драйвер будет поворачивать двигатель на 1 полный шаг, т.е. 1.8 градуса, а полный оборот сделает за 200 импульсов. Если изменить деление шагов на 1/8, то на каждый импульс от платы драйвер будет делать микрошаг размером в 1/8 полного шага. И за теже 200 импульсов сделает не полный оборот, а повернется на 45 градусов. Таким образом важно установить одинаковые настройки как для драйвера, так и для прошивки.

Для драйвера деление шагов задается перемычками MS1 MS2 на плате под драйвером. Установленная перемычка это 1, снятая 0. Для разных драйверов используются разные комбинации.

Для платы управления нужно задать количество шагов на 1 мм. Это количество меняется в зависимости от деления шагов установленных на драйвере. Стандартное количество шагов для деления 1/16:

```
>DEFAULT_X_STEPS_PER_UNIT	80
>DEFAULT_Y_STEPS_PER_UNIT	80
>DEFAULT_Z_STEPS_PER_UNIT	400
>DEFAULT_E0_STEPS_PER_UNIT	400
```
Значения по осям X,Y,Z в целом не нуждаются в какой-либо калибровке. Они зависят от настроек деления шагов и передаточного отношения привода. Таким образом, в случае изменения деления шагов изменяться эти величины будут кратно 2.

Количество шагов для экструдера - параметр который желательно откалибровать. Подробнее в [видео Дмитрия Соркина](https://www.youtube.com/watch?v=Mga_ezYDTNI) и на [вики](https://fbghost.info/bin/view/Main/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0/4S%20-%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D1%88%D0%B0%D0%B3%D0%BE%D0%B2%20%D1%8D%D0%BA%D1%81%D1%82%D1%80%D1%83%D0%B4%D0%B5%D1%80%D0%B0/). Для калибровки удобнее вынимать тефлоновую трубку не из головы, а из фидера.


## Типичные проблемы

*После замены драйверов или замены прошивки голова перемещается в противоположную сторону или на неверное расстояние

Не правильно установлено направление для оси или количество шагов. Как исправить: установите руками голову в центре и опустите немного стол, чтобы при попытке движения ничего никуда не врезалось. Из меню принтера попробуйте двигать каждой осью по 10мм. Если не совпадает направление движения - измените параметр INVERT_?_DIR для соответствующей оси. Перемещение можно измерить обычной линейкой, точность тут не нужна. Если неправильно выставлено количество шагов на мм, то голова будет перемещаться либо в 2,4,8 раз больше или меньше. Если на команду перемещения голова переместилась в 2 раза дальше чем нужно, значение DEFAULT_?_STEPS_PER_UNIT для соответствующей оси нужно сделать в 2 раза меньше. Если голова переместилась в 2 раза меньше, чем нужно, параметр DEFAULT_?_STEPS_PER_UNIT нужно увеличить в 2 раза.
*После прошивки на 5.8 принтер печатает сильно медленно

В настройках которые шли с прошивкой были установлены не оптимальные значения. В [telegram группе](https://t.me/Ghostbustersss) сделали нормальные настройки движения и исправили настройки безопасности. [Архив с прошивкой](./Ghost_5_firmware_V5-8_X-Dron.zip) Принтеры FB5 бывают с разными драйверами, установленными производителем, с разной настройкой деления шагов. Конфигурационный файл в архиве расчитан на деление 1/16, два драйвера TMC2225, два драйвер A4988. Если в вашем случае комплектация отличается, в файле настроек нужно будет инвертировать оси и изменить количество шагов на мм.